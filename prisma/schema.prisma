// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  uid        String    @id @default(uuid())
  name       String
  email      String    @unique
  chats1     Chat[]    @relation("User1")
  chats2     Chat[]    @relation("User2")
  messages   Message[]
  lastMsgs   LastMessage[] @relation("UserMessages")
  partnerMsgs LastMessage[] @relation("PartnerMessages")
}

model Chat {
  chat_id      String        @id @default(uuid())
  user1_id     String
  user2_id     String
  created_at   DateTime      @default(now())
  
  user1        User          @relation("User1", fields: [user1_id], references: [uid])
  user2        User          @relation("User2", fields: [user2_id], references: [uid])
  messages     Message[]
  lastMessages LastMessage[]
}

model Message {
  message_id String   @id @default(uuid())
  chat_id    String
  sent_by    String
  content    String
  sent_at    DateTime @default(now())

  chat   Chat @relation(fields: [chat_id], references: [chat_id])
  sender User @relation(fields: [sent_by], references: [uid])
}

model LastMessage {
  id             String   @id @default(uuid())
  user_id        String
  partner_id     String
  chat_id        String
  last_chat      String
  last_chat_date DateTime

  user     User @relation("UserMessages", fields: [user_id], references: [uid])
  partner  User @relation("PartnerMessages", fields: [partner_id], references: [uid])
  chat     Chat @relation(fields: [chat_id], references: [chat_id])

  @@unique([user_id, partner_id])
}